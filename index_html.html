<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>Envelope Calculator</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;
      const CM_PER_IN = 2.54;

      // Normalizza stringa input: accetta sia "," che "."
      const parseInput = (value, unit) => {
        if (value === "" || value === null || value === undefined) return NaN;
        const normalized = value.toString().replace(",", "."); 
        const num = Number(normalized);
        if (!isFinite(num)) return NaN;
        return unit === "in" ? num : num / CM_PER_IN;
      };

      const toDisplay = (num, unit, decimalsIn = 2, decimalsCm = 1) => {
        if (!isFinite(num)) return "";
        const val = unit === "in" ? num : num * CM_PER_IN;
        return unit === "in" ? val.toFixed(decimalsIn) : val.toFixed(decimalsCm);
      };

      function calculateScorPal(cardW_in, cardH_in) {
        const paperW_in = Math.max(cardH_in, cardW_in) + 1.25;
        const paperL_in = 2.5 * Math.min(cardW_in, cardH_in);
        const firstScore_in = Math.min(cardW_in, cardH_in) - 1.25;
        return { paperW_in, paperL_in, firstScore_in };
      }

      const EnvelopeCalculator = () => {
        const [cardWidth, setCardWidth] = useState("");
        const [cardHeight, setCardHeight] = useState("");
        const [unit, setUnit] = useState("cm");
        const [mode, setMode] = useState("ScorPal"); // 'Legacy' | 'ScorPal' | 'SquarePad'
        const [squareSize, setSquareSize] = useState("14.0");
        const [results, setResults] = useState(null);

        const handleUnitChange = (nextUnit) => {
          if (nextUnit === unit) return;
          setUnit(nextUnit);
        };

        const compute = () => {
          const w_in = parseInput(cardWidth, unit);
          const h_in = parseInput(cardHeight, unit);
          if (!isFinite(w_in) || !isFinite(h_in) || w_in <= 0 || h_in <= 0) {
            setResults(null);
            return;
          }

          if (mode === "Legacy") {
            const paperW_in = w_in + 0.5;
            const paperH_in = h_in + 1.0;
            const scoreW_in = w_in + 0.25;
            const scoreH_in = h_in + 0.25;
            setResults({
              mode,
              paper: `${toDisplay(paperW_in, unit)} × ${toDisplay(paperH_in, unit)} ${unit}`,
              score: `${toDisplay(scoreW_in, unit)} × ${toDisplay(scoreH_in, unit)} ${unit}`,
            });
            return;
          }

          if (mode === "ScorPal") {
            const sp = calculateScorPal(w_in, h_in);
            setResults({
              mode,
              paper: `${toDisplay(sp.paperW_in, unit)} × ${toDisplay(sp.paperL_in, unit)} ${unit}`,
              score: `${toDisplay(sp.firstScore_in, unit)} ${unit}`,
            });
            return;
          }

          if (mode === "SquarePad") {
            const sq_in = parseInput(squareSize, unit);
            const seam_in = 0.157; // ~0.4 cm
            const score_in = Math.min(w_in, h_in) - seam_in;
            setResults({
              mode,
              paper: `${toDisplay(sq_in, unit)} × ${toDisplay(sq_in, unit)} ${unit}`,
              score: `${toDisplay(score_in, unit)} ${unit}`,
              note: "Modalità SquarePad: la score line è la misura corta meno circa 0,4 cm.",
            });
            return;
          }
        };

        useEffect(() => {
          compute();
        }, [cardWidth, cardHeight, unit, mode, squareSize]);

        return (
          <div className="max-w-md mx-auto bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen p-4">
            <div className="bg-white rounded-xl shadow-lg p-6 mt-8">
              <div className="text-center mb-6">
                <h1 className="text-2xl font-bold text-gray-800">Envelope Calculator</h1>
                <p className="text-gray-600 text-sm mt-1">Scegli la modalità di calcolo</p>
              </div>

              {/* Unit toggle */}
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">Unità</label>
                <div className="flex rounded-lg border border-gray-200 overflow-hidden">
                  <button
                    onClick={() => handleUnitChange("cm")}
                    className={`flex-1 py-2 px-4 ${
                      unit === "cm" ? "bg-blue-600 text-white" : "bg-white text-gray-700"
                    }`}
                  >
                    cm
                  </button>
                  <button
                    onClick={() => handleUnitChange("in")}
                    className={`flex-1 py-2 px-4 ${
                      unit === "in" ? "bg-blue-600 text-white" : "bg-white text-gray-700"
                    }`}
                  >
                    in
                  </button>
                </div>
              </div>

              {/* Mode select */}
              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">Modalità</label>
                <select
                  value={mode}
                  onChange={(e) => setMode(e.target.value)}
                  className="w-full p-2 border rounded"
                >
                  <option value="ScorPal">Scor-Pal (formula tutorial)</option>
                  <option value="SquarePad">Square Pad (foglio quadrato)</option>
                  <option value="Legacy">Legacy (offset semplice)</option>
                </select>
              </div>

              {mode === "SquarePad" && (
                <div className="mb-4">
                  <label className="block text-sm text-gray-600 mb-1">Formato quadrato ({unit})</label>
                  <select
                    value={squareSize}
                    onChange={(e) => setSquareSize(e.target.value)}
                    className="w-full p-2 border rounded"
                  >
                    <option value={unit === "cm" ? "12.7" : (12.7 / CM_PER_IN).toFixed(2)}>
                      {unit === "cm" ? "12.7 cm" : "5.00 in"}
                    </option>
                    <option value={unit === "cm" ? "14.0" : (14.0 / CM_PER_IN).toFixed(2)}>
                      {unit === "cm" ? "14.0 cm (5.5\")" : "5.50 in (14.0 cm)"}
                    </option>
                    <option value={unit === "cm" ? "15.24" : (15.24 / CM_PER_IN).toFixed(2)}>
                      {unit === "cm" ? "15.24 cm (6\")" : "6.00 in (15.24 cm)"}
                    </option>
                    <option value={unit === "cm" ? "20.32" : (20.32 / CM_PER_IN).toFixed(2)}>
                      {unit === "cm" ? "20.32 cm (8\")" : "8.00 in (20.32 cm)"}
                    </option>
                  </select>
                </div>
              )}

              {/* Inputs */}
              <div className="bg-gray-50 rounded-lg p-4">
                <h3 className="font-semibold text-gray-800 mb-3">Card size</h3>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Larghezza</label>
                    <input
                      type="text"
                      value={cardWidth}
                      onChange={(e) => setCardWidth(e.target.value)}
                      className="w-full px-3 py-2 border rounded"
                      placeholder="0.0"
                    />
                    <div className="text-xs text-gray-500">{unit}</div>
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Altezza</label>
                    <input
                      type="text"
                      value={cardHeight}
                      onChange={(e) => setCardHeight(e.target.value)}
                      className="w-full px-3 py-2 border rounded"
                      placeholder="0.0"
                    />
                    <div className="text-xs text-gray-500">{unit}</div>
                  </div>
                </div>
              </div>

              {/* Results */}
              <div className="mt-4">
                <h3 className="font-semibold text-gray-800">Risultati</h3>
                {!results && (
                  <div className="text-sm text-gray-500">
                    Inserisci dimensioni valide per vedere i risultati.
                  </div>
                )}
                {results && (
                  <div className="mt-2 bg-white p-3 rounded border text-sm text-gray-700">
                    <div>Modalità: <strong>{results.mode}</strong></div>
                    <div className="mt-1">Paper: <strong>{results.paper}</strong></div>
                    <div className="mt-1">Score line: <strong>{results.score}</strong></div>
                    {results.note && <div className="mt-2 text-xs text-gray-500">{results.note}</div>}
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      };

      ReactDOM.render(<EnvelopeCalculator />, document.getElementById("root"));
    </script>
  </body>
</html>
