<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Envelope Calculator</title>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;
const CM_PER_IN = 2.54;

// ✅ Tabella WRMK / Stampin’Up completa
const WRMK_TABLE = [
  { cardW_in: 2,   cardH_in: 3.5, paper_in: 5.5,  score_in: 2 },
  { cardW_in: 2.5, cardH_in: 3.5, paper_in: 5.5,  score_in: 2.25 },
  { cardW_in: 3,   cardH_in: 3,   paper_in: 5.25, score_in: 2 },
  { cardW_in: 3,   cardH_in: 4,   paper_in: 6.5,  score_in: 2.75 },
  { cardW_in: 3.5, cardH_in: 3.5, paper_in: 6,    score_in: 2.625 },
  { cardW_in: 3.5, cardH_in: 5,   paper_in: 7.5,  score_in: 3 },
  { cardW_in: 4,   cardH_in: 4,   paper_in: 6.75, score_in: 3.375 },
  { cardW_in: 4,   cardH_in: 5,   paper_in: 8,    score_in: 3.5 },
  { cardW_in: 4,   cardH_in: 5.5, paper_in: 8.25, score_in: 3.375 },
  { cardW_in: 4.25,cardH_in: 4.25,paper_in: 7.25, score_in: 3.625 },
  { cardW_in: 4.25,cardH_in: 5.5, paper_in: 8.125,score_in: 3.625 },
  { cardW_in: 4.5, cardH_in: 6,   paper_in: 8.75, score_in: 3.625 },
  { cardW_in: 5,   cardH_in: 5,   paper_in: 8,    score_in: 3.5 },
  { cardW_in: 5,   cardH_in: 6.5, paper_in: 9.5,  score_in: 4 },
  { cardW_in: 5.5, cardH_in: 5.5, paper_in: 8.75, score_in: 4.375 },
  { cardW_in: 5.5, cardH_in: 7,   paper_in: 9.5,  score_in: 4.125 },
  { cardW_in: 6,   cardH_in: 6,   paper_in: 9.5,  score_in: 4.5 },
  { cardW_in: 6,   cardH_in: 8.5, paper_in: 11,   score_in: 4.375 },
  { cardW_in: 6.5, cardH_in: 6.5, paper_in: 10.5, score_in: 4.5 },
  { cardW_in: 7,   cardH_in: 7,   paper_in: 11.5, score_in: 4.5 },
  { cardW_in: 7,   cardH_in: 8,   paper_in: 11.5, score_in: 4.5 },
  { cardW_in: 8.5, cardH_in: 5.5, paper_in: 12,   score_in: 4.125 },
  { cardW_in: 8.5, cardH_in: 6,   paper_in: 12.5, score_in: 4.5 },
  { cardW_in: 8.5, cardH_in: 8.5, paper_in: 12.5, score_in: 4.5 }
];

// Normalizza input accettando "." e ","
const parseInput = (value, unit) => {
  if (!value) return NaN;
  const normalized = value.toString().replace(",", ".");
  const num = Number(normalized);
  if (!isFinite(num)) return NaN;
  return unit === "in" ? num : num / CM_PER_IN;
};

const toDisplay = (num, unit, decimalsIn = 2, decimalsCm = 1) => {
  if (!isFinite(num)) return "";
  const val = unit === "in" ? num : num * CM_PER_IN;
  return unit === "in" ? val.toFixed(decimalsIn) : val.toFixed(decimalsCm);
};

function calculateScorPal(cardW_in, cardH_in) {
  const paperW_in = Math.max(cardH_in, cardW_in) + 1.25;
  const paperL_in = 2.5 * Math.min(cardW_in, cardH_in);
  const firstScore_in = Math.min(cardW_in, cardH_in) - 1.25;
  return { paperW_in, paperL_in, firstScore_in };
}

const EnvelopeCalculator = () => {
  const [cardWidth, setCardWidth] = useState("");
  const [cardHeight, setCardHeight] = useState("");
  const [unit, setUnit] = useState("cm");
  const [mode, setMode] = useState("ScorPal");
  const [squareMode, setSquareMode] = useState("table"); // "table" | "custom"
  const [squareSize, setSquareSize] = useState("14.0");
  const [results, setResults] = useState(null);
  const [selectedWRMK, setSelectedWRMK] = useState(null);

  const handleUnitChange = (nextUnit) => {
    if (nextUnit === unit) return;
    setUnit(nextUnit);
  };

  const compute = () => {
    const w_in = parseInput(cardWidth, unit);
    const h_in = parseInput(cardHeight, unit);
    if (!isFinite(w_in) || !isFinite(h_in) || w_in <= 0 || h_in <= 0) {
      setResults(null);
      return;
    }

    if (mode === "Legacy") {
      const paperW_in = w_in + 0.5;
      const paperH_in = h_in + 1.0;
      const scoreW_in = w_in + 0.25;
      const scoreH_in = h_in + 0.25;
      setResults({
        mode,
        paper: `${toDisplay(paperW_in, unit)} × ${toDisplay(paperH_in, unit)} ${unit}`,
        score: `${toDisplay(scoreW_in, unit)} × ${toDisplay(scoreH_in, unit)} ${unit}`,
      });
      return;
    }

    if (mode === "ScorPal") {
      const sp = calculateScorPal(w_in, h_in);
      setResults({
        mode,
        paper: `${toDisplay(sp.paperW_in, unit)} × ${toDisplay(sp.paperL_in, unit)} ${unit}`,
        score: `${toDisplay(sp.firstScore_in, unit)} ${unit}`,
      });
      return;
    }

    if (mode === "SquarePad") {
      if (squareMode === "table" && selectedWRMK) {
        const { paper_in, score_in } = selectedWRMK;
        setResults({
          mode,
          paper: `${toDisplay(paper_in, unit)} × ${toDisplay(paper_in, unit)} ${unit}`,
          score: `${toDisplay(score_in, unit)} ${unit}`,
          note: "Dati presi dalla tabella ufficiale WRMK/Stampin’Up.",
        });
        return;
      }
      if (squareMode === "custom") {
        const sq_in = parseInput(squareSize, unit);
        const seam_in = 0.157; // ~0.4 cm
        const score_in = Math.min(w_in, h_in) - seam_in;
        setResults({
          mode,
          paper: `${toDisplay(sq_in, unit)} × ${toDisplay(sq_in, unit)} ${unit}`,
          score: `${toDisplay(score_in, unit)} ${unit}`,
          note: "Modalità Custom Square: score line ≈ lato corto − 0,4 cm.",
        });
        return;
      }
    }
  };

  useEffect(() => {
    compute();
  }, [cardWidth, cardHeight, unit, mode, squareSize, squareMode, selectedWRMK]);

  return (
    <div className="max-w-md mx-auto bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen p-4">
      <div className="bg-white rounded-xl shadow-lg p-6 mt-8">
        <div className="text-center mb-6">
          <h1 className="text-2xl font-bold text-gray-800">Envelope Calculator</h1>
          <p className="text-gray-600 text-sm mt-1">Scegli la modalità di calcolo</p>
        </div>

        {/* Unit toggle */}
        <div className="mb-4">
          <label className="block text-sm font-medium text-gray-700 mb-2">Unità</label>
          <div className="flex rounded-lg border border-gray-200 overflow-hidden">
            <button
              onClick={() => handleUnitChange("cm")}
              className={`flex-1 py-2 px-4 ${unit === "cm" ? "bg-blue-600 text-white" : "bg-white text-gray-700"}`}
            >
              cm
            </button>
            <button
              onClick={() => handleUnitChange("in")}
              className={`flex-1 py-2 px-4 ${unit === "in" ? "bg-blue-600 text-white" : "bg-white text-gray-700"}`}
            >
              in
            </button>
          </div>
        </div>

        {/* Mode select */}
        <div className="mb-4">
          <label className="block text-sm font-medium text-gray-700 mb-2">Modalità</label>
          <select
            value={mode}
            onChange={(e) => setMode(e.target.value)}
            className="w-full p-2 border rounded"
          >
            <option value="ScorPal">Scor-Pal (formula tutorial)</option>
            <option value="SquarePad">Square Pad (foglio quadrato)</option>
            <option value="Legacy">Legacy (offset semplice)</option>
          </select>
        </div>

        {/* SquarePad extra options */}
        {mode === "SquarePad" && (
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">Opzioni SquarePad</label>
            <div className="flex mb-2">
              <button
                onClick={() => setSquareMode("table")}
                className={`flex-1 py-2 px-3 ${squareMode === "table" ? "bg-blue-600 text-white" : "bg-gray-100"}`}
              >
                Tabella WRMK/SU
              </button>
              <button
                onClick={() => setSquareMode("custom")}
                className={`flex-1 py-2 px-3 ${squareMode === "custom" ? "bg-blue-600 text-white" : "bg-gray-100"}`}
              >
                Custom
              </button>
            </div>

            {squareMode === "table" && (
              <select
                onChange={(e) => setSelectedWRMK(JSON.parse(e.target.value))}
                className="w-full p-2 border rounded"
              >
                <option>-- Seleziona card dalla tabella --</option>
                {WRMK_TABLE.map((row, i) => (
                  <option key={i} value={JSON.stringify(row)}>
                    Card {row.cardW_in}" × {row.cardH_in}" → Paper {row.paper_in}" (score {row.score_in}")
                  </option>
                ))}
              </select>
            )}

            {squareMode === "custom" && (
              <div className="mt-2">
                <label className="block text-sm text-gray-600 mb-1">Formato quadrato ({unit})</label>
                <input
                  type="text"
                  value={squareSize}
                  onChange={(e) => setSquareSize(e.target.value)}
                  className="w-full p-2 border rounded"
                  placeholder="es. 14.0"
                />
              </div>
            )}
          </div>
        )}

        {/* Inputs */}
        <div className="bg-gray-50 rounded-lg p-4">
          <h3 className="font-semibold text-gray-800 mb-3">Card size</h3>
          <div className="grid grid-cols-2 gap-3">
            <div>
              <label className="block text-sm text-gray-600 mb-1">Larghezza</label>
              <input
                type="text"
                value={cardWidth}
                onChange={(e) => setCardWidth(e.target.value)}
                className="w-full px-3 py-2 border rounded"
                placeholder="0.0"
              />
              <div className="text-xs text-gray-500">{unit}</div>
            </div>
            <div>
              <label className="block text-sm text-gray-600 mb-1">Altezza</label>
              <input
                type="text"
                value={cardHeight}
                onChange={(e) => setCardHeight(e.target.value)}
                className="w-full px-3 py-2 border rounded"
                placeholder="0.0"
              />
              <div className="text-xs text-gray-500">{unit}</div>
            </div>
          </div>
        </div>

        {/* Results */}
        <div className="mt-4">
          <h3 className="font-semibold text-gray-800">Risultati</h3>
          {!results && <div className="text-sm text-gray-500">Inserisci dimensioni valide per vedere i risultati.</div>}
          {results && (
            <div className="mt-2 bg-white p-3 rounded border text-sm text-gray-700">
              <div>Modalità: <strong>{results.mode}</strong></div>
              <div className="mt-1">Paper: <strong>{results.paper}</strong></div>
              <div className="mt-1">Score line: <strong>{results.score}</strong></div>
              {results.note && <div className="mt-2 text-xs text-gray-500">{results.note}</div>}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

ReactDOM.render(<EnvelopeCalculator />, document.getElementById("root"));
</script>
</body>
</html>
